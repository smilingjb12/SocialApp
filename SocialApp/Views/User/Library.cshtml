@{
    ViewBag.Title = "Library";
}

<style>
    .first-row {
        padding-top: 20px;
    }
    #browse-btn {
        margin-right: 10px;
    }

    #song-edit-modal form {
        width: 350px;
        margin: 0 auto;
    }
    .album-cover {
        max-width: 170px;
    }
</style>
<link href="~/Content/bootstrap/file-input-wrapper.css" rel="stylesheet" />

<div class="row first-row">
    <div class="col-xs-9">
        <table class="table table-striped table-bordered table-hover">
            <tbody>
                @foreach (int i in Enumerable.Range(0, 10))
                {
                    <tr>
                        <td>One</td>
                        <td>Two</td>
                        <td>Three</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div class="col-xs-3">
        <div class="panel panel-default">
            <div class="panel-body">
                <a href="#" class="btn btn-success btn-block" id="upload-btn" data-toggle="modal" data-target="#upload-modal">
                    <span class="glyphicon glyphicon-cloud-upload"></span>&nbsp;Upload
                </a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="upload-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title text-center">Song upload</h4>
            </div>
            <div class="modal-body">
                <span id="browse-btn" class="btn btn-primary btn-file">
                    <span class="glyphicon glyphicon-folder-open"></span>&nbsp;
                    Browse
                    <input type="file" data-bind="event: {change: fileSelected}" />
                </span>
                <span class="file-name">Choose a track to upload</span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script type="text/template" id="upload-song-template">
    <div class="progress progress-striped active">
        <div id="upload-progress" class="progress-bar" role="progressbar" style="width: 0%">
    </div>
</script>

<div class="modal fade" id="song-edit-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title text-center">Song edit</h4>
            </div>
            <div class="modal-body">
                <div class="alert alert-success alert-dismissable fade in">
                    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>Edit song info if you like. Press "save" to finish
                </div>
                <img data-bind="attr: {src: song.albumCoverPicturePath}" alt="Album cover" class="center-block album-cover img-thumbnail" />
                <form role="form">
                    <div class="form-group">
                        <label for="song-title">Title</label>
                        <input id="song-title" type="text" class="form-control" data-bind="value: song.title" placeholder="Title" />
                    </div>
                    <div class="form-group">
                        <label for="song-artist">Artist</label>
                        <input id="song-artist" type="text" class="form-control" data-bind="value: song.artist" placeholder="Artist" />
                    </div>
                    <div class="form-group">
                        <label for="song-album">Album</label>
                        <input id="song-album" type="text" class="form-control" data-bind="value: song.album" placeholder="Album" />
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-dismiss="modal" data-bind="click: updateSong">Save</button>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    @Scripts.Render("~/bundles/knockout")
    <script src="~/Scripts/mine/song-uploader.js"></script>
    <script>
        function SongModel(json) {
            var self = this;
            
            self.id = ko.observable(json.id);
            self.title = ko.observable(json.title);
            self.artist = ko.observable(json.artist);
            self.album = ko.observable(json.album);
            self.likes = ko.observable(json.likes);
            self.albumCoverPicturePath = ko.observable(json.albumCoverPicturePath);
        }

        function AppModel() {
            var self = this;

            self.song = new SongModel({});
            window.song = self.song; // TODO: REMOVE

            self.fileSelected = function() {
                var file = document.querySelector('#upload-modal [type=file]').files[0];
                $('#upload-modal .modal-body').fadeOut(function() {
                    var modalBody = $(this);
                    var progressBarHtml = $('#upload-song-template').html();
                    modalBody.html(progressBarHtml).fadeIn();
                    var songUploader = new SongUploader(file);
                    songUploader.upload(function done() {
                        // TODO: map this
                        self.song.id(this.uploadedSong.id);
                        self.song.title(this.uploadedSong.title);
                        self.song.artist(this.uploadedSong.artist);
                        self.song.album(this.uploadedSong.album);
                        self.song.likes(this.uploadedSong.likes);
                        self.song.albumCoverPicturePath(this.uploadedSong.albumCoverPicturePath);
                            
                        setTimeout(function() { // emulating processing
                            $('#upload-modal').modal('hide');
                            $('#song-edit-modal').modal('show');
                        }, 500);
                    });
                });
            };

            self.updateSong = function() {
                $.post('/song/update', ko.toJS(self.song), function(resp) {
                    // TODO: do something
                    console.log(resp);
                });
            };
        }

        ko.applyBindings(new AppModel());
    </script>
}